# fastlane/Fastfile
ENV["FASTLANE_EXPLICIT_OPEN_SIMULATOR"] = "1"
ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "120"
ENV["FASTLANE_XCODE_LIST_TIMEOUT"] = "120"

default_platform(:ios)

platform :ios do

  desc "Build for UI tests"
  lane :build do
    scan(
      project: "FlowCrypt.xcodeproj",
      scheme: "Debug FlowCrypt",
      device: "iPhone 17 (26.0)",
      derived_data_path: "/var/tmp/derived_data/FlowCrypt",
      skip_detect_devices: true,
      build_for_testing: true,
      # IPHONEOS_DEPLOYMENT_TARGET=18.4 for fixing crash on 18.5 simulator
      xcargs: "IPHONEOS_DEPLOYMENT_TARGET=18.4 -skipPackagePluginValidation -skipMacroValidation -allowProvisioningUpdates",
    )
  end

  desc "Run Swift tests"
  lane :test do
    scan(
      project: "FlowCrypt.xcodeproj",
      scheme: "FlowCryptAppTests",
      device: "iPhone 17 (26.0)",
      test_without_building: true,
      derived_data_path: "/var/tmp/derived_data/FlowCrypt",
      xcargs: "-skipPackagePluginValidation -skipMacroValidation",
      parallel_testing: false,
      disable_concurrent_testing: true
    )
  end

end

