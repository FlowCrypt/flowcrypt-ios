version: v1.0
name: FlowCrypt iOS App

execution_time_limit:
  minutes: 30

agent:
  machine:
    type: a1-standard-4
    os_image: macos-xcode12

blocks:
  - name: iOS Tests
    execution_time_limit:
      minutes: 25
    task:
      secrets:
        - name: flowcrypt-ios-ci-secrets
      env_vars:
        - name: LANG
          value: en_US.UTF-8
        - name: SEMAPHORE_GIT_DIR
          value: /Users/semaphore/git/flowcrypt-ios
      prologue:
        commands:
          - checkout
          - cd ~/git/flowcrypt-ios/
          - cache restore
          - gem install bundler -v 1.17.3
          - bundle install --path vendor/bundle
          - cache store
          - mv ~/test-ci-secrets.json ~/git/flowcrypt-ios/test-ci-secrets.json
      jobs:
        #- name: 'FlowCryptTests'
        #  commands:
        #    - bundle exec fastlane do_everything

        - name: 'FlowCryptTests(with email server)'
          commands: 
            # Install Docker
            - brew install --cask docker
            # Install Docker-compose
            - brew install docker-compose
            # Run an email server
            # Docker daemon uses Linux-specific kernel features. 
            # Install docker-machine in order to create VM and attach to it.
            - brew install docker-machine docker
            # docker-machine relies on VirtualBox
            # install Virtualbox
            - brew install --cask virtualbox
            # Install telnet
            - brew install telnet
            # Install docker toolbox
            - brew install --cask docker-toolbox
            # Start virtualbox
            - docker-machine create -d virtualbox --virtualbox-no-vtx-check default || true
            # Start Docker
            - docker-machine start default || true
            - docker-compose --version
            # Run mail server
            - cd docker-mailserver && ./run_email_server.sh && ./print_debug_info.sh && cd -


            # - brew install --cask docker-toolbox
            # - docker-machine create --driver "virtualbox" box --virtualbox-no-vtx-check
            # - docker-machine start box 
            # - cd docker-mailserver && ./run_email_server.sh && ./print_debug_info.sh && cd -

